name: Auto-merge Renovate PRs

permissions:
  contents: write       # Allows merging PRs
  pull-requests: write  # Allows updating PR status

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_run:
    workflows: ["Main"]
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    # Only run on Renovate PRs
    if: github.event.pull_request.user.login == 'renovate[bot]' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request')

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            # For workflow_run events, extract PR number from the triggering workflow
            PR_NUMBER=$(gh pr list --repo ${{ github.repository }} --head ${{ github.event.workflow_run.head_branch }} --json number --jq '.[0].number')
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if PR is from Renovate
        id: check-renovate
        run: |
          PR_AUTHOR=$(gh pr view ${{ steps.pr.outputs.number }} --json author --jq '.author.login')
          echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT

          if [ "$PR_AUTHOR" = "renovate[bot]" ]; then
            echo "is_renovate=true" >> $GITHUB_OUTPUT
          else
            echo "is_renovate=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if major update
        id: check-major
        if: steps.check-renovate.outputs.is_renovate == 'true'
        run: |
          PR_TITLE=$(gh pr view ${{ steps.pr.outputs.number }} --json title --jq '.title')

          # Check if PR requires approval (major updates)
          if echo "$PR_TITLE" | grep -qiE '\bmajor\b'; then
            echo "is_major=true" >> $GITHUB_OUTPUT
            echo "Major update detected - skipping auto-merge (requires manual approval)"
          else
            echo "is_major=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for CI to complete
        if: steps.check-renovate.outputs.is_renovate == 'true' && steps.check-major.outputs.is_major == 'false'
        run: |
          echo "Waiting for CI checks to complete..."

          # Wait up to 10 minutes for checks to complete
          TIMEOUT=600
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Check if all required checks have passed
            CHECKS_STATUS=$(gh pr checks ${{ steps.pr.outputs.number }} --json state --jq 'map(select(.state != "SUCCESS")) | length')

            if [ "$CHECKS_STATUS" = "0" ]; then
              echo "All CI checks passed!"
              exit 0
            fi

            echo "Waiting for checks... ($ELAPSED/$TIMEOUT seconds)"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done

          echo "Timeout waiting for CI checks"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge
        if: steps.check-renovate.outputs.is_renovate == 'true' && steps.check-major.outputs.is_major == 'false'
        run: |
          gh pr merge ${{ steps.pr.outputs.number }} --auto --squash
          echo "âœ… Auto-merge enabled for PR #${{ steps.pr.outputs.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
