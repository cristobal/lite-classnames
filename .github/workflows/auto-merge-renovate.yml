name: Auto-merge Renovate PRs

permissions:
  contents: write       # Allows merging PRs
  pull-requests: write  # Allows updating PR status

on:
  pull_request_target:
    types: [opened, reopened]

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    # Only run on Renovate PRs
    if: github.event.pull_request.user.login == 'renovate[bot]'

    steps:
      - name: Check labels
        id: check-labels
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'

          # Check if PR has both required labels
          if echo "$LABELS" | jq -e 'contains(["renovate"]) and contains(["dependencies"])' > /dev/null; then
            echo "has_labels=true" >> $GITHUB_OUTPUT
            echo "✅ PR has required labels: renovate, dependencies"
          else
            echo "has_labels=false" >> $GITHUB_OUTPUT
            echo "⚠️  PR missing required labels"
            echo "Labels found: $LABELS"
          fi

      - name: Check if major update
        id: check-major
        if: steps.check-labels.outputs.has_labels == 'true'
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Check if PR title contains "major" (skip auto-merge for major updates)
          if echo "$PR_TITLE" | grep -qiE '\bmajor\b'; then
            echo "is_major=true" >> $GITHUB_OUTPUT
            echo "⚠️  Major update detected - skipping auto-merge (requires manual approval)"
            echo "PR: $PR_TITLE"
          else
            echo "is_major=false" >> $GITHUB_OUTPUT
            echo "✅ Minor/patch update detected"
            echo "PR: $PR_TITLE"
          fi

      - name: Enable auto-merge
        if: steps.check-labels.outputs.has_labels == 'true' && steps.check-major.outputs.is_major == 'false'
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --auto --squash --repo ${{ github.repository }}
          echo "✅ Auto-merge enabled for PR #${{ github.event.pull_request.number }}"
          echo "PR will be automatically merged once all CI checks pass"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
